from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
from sklearn.cluster import DBSCAN

import numpy as np 
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.image as mpimg
import os

# from utils_fc import sanitize_filename, open_and_display_images

def assign_groups_by_text_clustering(df, eps, min_samples, save_path=None):
    """
    Assigns group labels to the dataframe based on the clustering of strings in the 'Type' column,
    using text similarity and DBSCAN clustering, and optionally saves the modified DataFrame to a CSV file.

    Parameters:
        df (pd.DataFrame): DataFrame containing a 'Type' column to cluster by text similarity.
        eps (float): The maximum distance between two samples for one to be considered as in the neighborhood of the other.
        min_samples (int): The number of samples in a neighborhood for a point to be considered as a core point.
        save_path (str, optional): Path to save the modified DataFrame as a CSV file. If None, no file is saved.

    Returns:
        pd.DataFrame: A modified DataFrame with an additional column indicating the cluster label.
    """
    # Get unique types and preprocess them
    # types = df['Code'].dropna().unique()
    types = ['10,0-SELUX URBI 2 Z NOK 2 UITH-2-00', '10,0-SPANM GVB OVERTM OV/VRI 7016', '00,0-ZELFST INFRA AANSL-0-00','10,0-ANWB NPK 2DEUR TOP76-0-00', '12,0-GAAT VV BUISC 1DEUR ZGRV-0-00', '08,0-GRNSTK 1,1M 4GRVL GRNDPLT-0-00', '06,0-TOP60 GRST40CM VPL 9005/P-0-00', '04,0-HERMES RVS INDIRECT-0-00', '04,5-ANWB LWW AAN TRAMMAST-0-00', '04,5-BEGA725-TOP76-ZWART-0-00', '04,0-ARM IN HEK DERDEN-0-00', '08,0-CO GRNDST GRVL GRDPL 9006-0-00', '10,0-TOP80 7016/P-0-00', '10,0-M VPL EN 2DEUR-0-00', '00,0-KAST INB RVS 300X200X150-0-00', '10,0-CILINDRISCH 8 BEGA RVS-8-00', '14,0-CIL CON VOETPLAAT TOP 108-0-00', '15,7-PALMBOOM 9006 TYPE A2,B2,C2 (P', '10,0-CIL CON VERL TOP 73-0-00', '178 0', '08,0-BEGA CON 76-0-00', '09,5-CILINDRISCH 3 BEGA ARM-3-00', '15,0M CIL 5LPH D324 2D R7030', '02,9-GRACHTPAAL KUNSTSTOF OM-0-00', '11,0-CIL DRAADBUS 5011-0-00', '12,0M BUISMAST ARENA BOULEVARD R704', '9', '16,0-COMB OV/GVB LPH11>14 7021-0-00', '08,0-BUISC SPEC VPL-0-00', '12,0-BUISC OPZETDI 108MM-0-00', '08,0-COMB OV/VRI 2DEUR ZWWIT-0-00', '10,0-CIL 2UITH RIEKENPOLDER-2-00', '03,3-VPL 9005/P-0-00', '08,0-CO GRNDST GRVL GRDPL 9005-0-00', '06,0-ICON VTPL CIL 2XUITH 9005-2-00', '08,0-VERL VST GEBUITL 0.75M/15-1-00', '08,0-4004-0-00', '04,1-CIL D133 T76 1D 7021-0-00', '04,0-CIL D121 1D OVERTOOM 7016-1-00', '02,5-VPL-0-00', '10,0-VERL ALU M VAST UITL (RWS-1-00', '01,1-KAST ZUIL (FAGET)-0-00', '08,0-HESS DRESDEN-VERL TOP76 VERZ 9', '08,0-7038 TOP70-0-00', '04,8-GIETIJZER NM 4,75 1 KRUL-0-00', '04,3-BUISM VERL-0-00', '10,0-NPK 1DEUR TOP76-0-00', '04,0-VRLP SELUXSAT TOP89 9005-0-00', '14,0-BUISC (D=245MM) 1 DEUR-0-00', '05,0-CONISCH T76 1D 7012-0-00', '500 0', '09,0-PHILIP STARCK GY  M VPL-0-00', '14,6-AFSP VPL GVB/OV UITL 8.1M-1-00', '05,4-BUISCON CIL CON-0-00', '09,0-TELEPORT 2/2 9017+7024-0-00', '07,8-VERL MOD LAREN 1VAST UIT-1-5M', '287 0', '03,5-GEHEEL CONISCH-0-00', '08,0-2DEUR OV/VRI TOP76 CAL150 ZW 9', '08,0-7038-0-00', '00,0-VOEDING OV INST-0-00', '10,0-VPL 7038/P-0-00', '10,0-CIL VARAS GEL 9006/P VPL-0-00', '10,0-VERLENGSTUK TRAM ?./2000-0-00', '11,0-NPK AFSPANMAST 1 DEUR-0-00', '10,0-ANWB-0-00', '14,0M PLEINMAST MAX 6xUITHOUDER 2D', '08,0-BEGA CON 76 VPL-0-00', '16,0-M VPL+BEV.PUNTEN-0-00', 'VOEDINGSKAST + SOKKEL OPB RIJKSMUSE', '08,0-CONSTR BASKETBV KATTENB-0-00', '6M VOETSTUK GIETIJZER OM + FUNDATIE', '04,0-BUISM VTPL ZDEUR-0-00', '13,8-OLYM.STADION-PMF1300998-1-00', '03,0-AGMI LZR150 1XPLL36-0-00', '14,0-CONISCH T133/159 1D 9006-0-00', '05,0-TOP76-7021/P-0-00', '03,5-INSTALL OP/AAN OBJ DERDEN-0-00', '15,0-BUITENM M OPZST.V SCHIJNW-0-00', '04,0-CON-GRST 1,25M-0-00', '12,0M NPK T76 1D+VOETPLAAT 7021+900', '08,0-5,4M BUS VOP BORD ZW/WIT-0-00', '04,0-TOP76 9004/P-0-00', '08,5-KANTEL T76 CONTRA60 9006-0-00', '04,0-HESS TOLEDO-VERL TOP76 VERZ 90', '05,5-BOOG LPH 5.5 M SELUX 7038-0-00', '06,3-PLESMANLAAN 7038-1-00', '10,0-BUISMAST 1DEUR-0-00', '08,0-VPL 7038/P-0-00', '10,0-SPANM GVB OVEROOM OV/GVB-0-00', '293 0', '04,0-CIL OVERTOOM 7016-0-00', '06,2-MILEWIDE VAST UITL 1M-1-00', '14,0-ANWBKUNSTSTOF UITL-1-00', '12,0-BUISC CIL.CON-0-00', '07,0-T.B.V. SELUX ANTWERPEN-4-00', '6M VOETSTUK GIETIJZER NM + FUNDATIE', '04,0-VRLP TOP 60MM VPL 5011/P-0-00', '13,8-OLYM.STADION- PMF1301026_-1-00', 'M.....', '09,0-DAMRAK 3 UITL SPECTRA-3-00', 'MAST-LICHT-4 M-RAL5011/ POEDER', '00,0-VOEDING 24V LED BRUGBOOG-0-00', '12,0-ANWB-0-00', '10,0-SELUX URBI2 VPL ZNOK 1UIT-1-00', '16,0-PLEIN OUD 8XUITH VTP 7021-0-00', '04,5-ZUIL SCHR CDMT150 9005/P-0-00', '05,0-CIL GETRAPT T60 1D VZ OGA-0-00', '10,0-GAAT VV VAST UITL 1.5M-1-00', '06,2-MILEWIDE VAST UITL 1M VPL 15°S', '08,0-CILINDRISCH 3 BEGA 9005-3-00', '03,5-ZUIL LEIDSCHE RIJN VPL-0-00', '10,0-CIL TOP168+6STFLENS9005/P-0-00', '14,5-CIL STAAL 1DEUR-0-00', '10,0-CILCON TOP108+TOPSTUK-3-00', '09,0-CIL STL 6VAST STEUN GEL-0-00', '04,8-VAST UITL 1M-1-00', '10,0-CILINDRISCH 5 SCHIJNW RVS-5-00', '282 0', '06,0-KLEINE VPL TOP60-0-00', '12,0-7021P-0-00', '05,0-ZWEEPMAST VOOR VOP ARMATU-1-00', '047 0', '164 0', '02,9-VERL TOP89 VPL 9005-0-00', '10,0-1DEUR+VPL-0-00', '06,0-VERL DUBB GEBUIT 0,75/15°-2-00', 'KAST 900x810x171 GRIJS MET TRANSPAR', '001 0', '10,8-OPZETSTUK TRAMM NPK 9006-0-00', '048 0', '12,0-GAAT VV BUISC 1DEUR MGRV-0-00', '10,0-BUISC 2DEUR V.UITL 2M-1-00', '14,0-BUISC VPL 1DEUR-0-00', 
    '03,5-CON 1V D=133 T89 1D 9005-0-00', 'M7100744', '03,0-PARKM-GY-LUIK-LADDERS-0-00', '12,5-RC HOEK5° 5BEGA ARM-5-00', '08,8-BUISCON CIL CON-0-00', '14,0M PLEINMAST MAX 6xUITHOUDER VPL', '10,8-DREVEN/GRNDST UITH DUBBEL-2-00', '10,8-DREVEN/VOETPL UITH ENKEL-1-00', '13,8-OLYM.STADION-PMF1300997_-1-00', '06,0-VOET OM+VRLSTK70/5250-0-00', '04,0-VRLP VSELUXSAT TOP89 5011-0-00', '00,0-KAST INB RVS GROOT-0-00', '2,9M GRACHTPL VPL NM1883 ZLUIK REVI', '06,0-CO GRNDST GRVL GRDPL 9006-0-00', '03,8-CIL 159MM TOP60 ANNAPURNA-0-00', '038 0', '05,7-CIL CON TBV KRUL TOP73-0-00', '04,0-CIL 121MM VPL RVS IN POEF-0-00', '00,0-MATR DERDEN-0-00', '042 0', 'ABRI', '03,5-VRLP SELUX SAT VPL TOP89  9005', '501 0', '090 0 1111', '04,0-TOP76 7021/P-0-00', '10,0-1Z GEBOGEN TYPE RAGNI-0-00', '08,0-TOP76 CAL105 9005/P-0-00', '04,5-ANWB LWW AAN OV OBJ-0-00', '12,5-RC 4BEGA ARM VOETPLAAT-4-00', '12,0-GAAT VV BUISC TOP108MM-0-00', '06,0-TOP60 GRST60CM VPL 9005/P-0-00', '15,5-CIL CON STATIONSPLEIN-0-00', '268 0', '03,5-TOP89 TUSSEN SCHF250MM-0-00', 'OPHANGBEUGEL VOOR ENOSE LUCHTKWALIT', '8M VOETSTUK GIETIJZER OM + FUNDATIE', '10,4-BUISM SELUX-VPL-MNOK1/2UH-0-00', 'M7100313', '06,5-ZUIL BEGA 8998S 3XTLD58HF-0-00', '05,0-TUNNEL-POORT-VIADUCT E.D-0-00', '163 0', '062 0', 'M..', '03,0-LICHTSTELEN 7025-0-00', '063 0', '10,8-DREVEN/GRNDST UITH ENKEL-1-00', '10,0-VPL-TOP80MM-7016/POEDER-0-00', '10,0-7038/WANDDIKTE 6,3MM-1-00', '03,5-VRLP SELUXSAT TOP89 9005/P-0-0', '06,0-PLESMANL V 2Z SCHUIN UITL 7038', '08,5-KANTEL T76 CONTRA44 9006-0-00', '05,5-RAGNI VLAGM GEB UITL NICE-0-00', '07,0-ZUIL IRB606-7000 VOETPLT-0-00', '08,0-CIL RVS 6VAST STEUN GEL-6-00', '06,0-DUAL WING-LOUIS.P 2BEUGL-0-00', '03,2-CIL VPL TOP76 CAL130 BEGA-0-00', '03,5-TBV ARM.ZOB A&G-7032-0-00', '05,0-ECLATEC MASSAI METRO ST P-0-00', '10,0-7021P-0-00', '10,2-SPANMAST CV T127 2D7038ZW-0-00', '06,0-DAMRAK 2 UITL SPECTRA-2-00', '08,0-DEUR DICHT GELAST-1-00', '06,1-VERL MODLAREN 2UITH-0-00', '8M VOETSTUK GIETIJZER NM + FUNDATIE', '16,0-PLEIN 6XUITHOUDER 7021-6-00', '12,0-GAAT VV 2UITH 0,8-2-00', '05,0-CIL 114MM-TOP60-9005/P-0-00', '12,0-1DEUR 1 VAST UITL 1,2M-1-00', '039 0', '06,0-GEINT I LUIFEL TOP76 7037-0-00', '12,5-RC HOEK 5° 4BEGA ARM-4-00', '10,3-TELEP2/2 2D 9017+7024+Z/W-1-00', '14,5-CIL TUIMEL 1DEUR-0-00', '07,0-BUISC EXTR DEUR V LANTRN VRI-0', '04,5-GEB UITH-1-00', '04,8-VOETSTUK OM REVISIE 7038-0-00', '02,0-VERKEERSAAND (PLATTEGR)-0-00', '328 0', '08,0-VOET NM+VRLSTK 89/ 7570MM-0-00', 'M...', '059 0', '04,0-M VPL-ZWART-0-00', '00,0-KAST V GGD/POLITIE-0-00', '08,0-CIL/CON VERL TOP73-0-00', '06,0-CON 2GEB UITH LPH 4.5/6.7-2-00', '10,0-TELEP 2UITL TYPE 13-01-1-00', '10,0-RAL9006/P-0-00', '003 0', '14,0-RVS TYPE DAMMAST-0-00', '04,0-CONISCH T76 1D 9004-0-00', '08,0-NPK VPL 1DEUR TOP76-0-00', '08,0-CIL RVS 3VAST STEUN GEL-3-00', '454 0', '203 0', '05,1-ZUIL IRB606-5100 SOKKEL-0-00', '04,0-CIL OVERTM OV/VRI ZW 7016-0-00', '04,8-RVS DAMM LASAG MET REFL SPIEGE', '10,0-NPK 2DEUR TOP76-0-00', '05,0-CON GENORMALIS-0-00', '10,0-SELUX URBI2 VPL ZNOK 2UIT-2-00', '05,0-TOP76/P-0-00', '09,5-CILINDRISCH 2 BEGA ARM-2-00', '11M VERST PLEINMAST VPL 1D MAX 3x', '10,0-CIL VP+VERL TOP 70 OV/VRI-0-00', '10,3-TELEP2/4 2D 9017+7024+Z/W-3-00', 'KAST 1000x1100x350 SCHUIN AFDAKJE S', '10,0-GRPL+BEV.PUNTEN-0-00', '2,9M GRACHTPL NM1883 ZLUIK REVISIE ', '06,0-VERL(MARLIN)-TOP76-9006/P-0-00', '02,9-GRACHT NM1883 ZL 3007 NWE-0-00', '07,0-NPK 1DEUR TOP 76-0-00', '06,1-VERL MOD LAREN 1VAST UIT 1,5M', '08,0-CON T60 GRONDSTUK 1,1M-0-00', '10,0-TELEP 1UITL TYPE13-01_2/2-1-00', '07,4-VPL TOP76 BEGA 9004-0-00', '03,5-M VPL-0-00', '11,0-AFSP GVB/OV TOP139-1-00', '03,5-9006/ P-0-00', '10,0-BUISMAST 2DEUR-0-00', '12,0-RVS-0-00', '04,9-TELEP-LOS NOK SCHOONEB-1-00', '10,0-KANTEL-CUPROHAAG-0-00', 'M7100123', '442 0', '0,5M ZUILKAST ELEQ 2RVS60 R7032', '04,0-CIL VERL TOP76 9005/P-0-00', '10,0-7038 TOP70-0-00', '044 0', '10,0-SPEC.VPL 7038/P-0-00', '00,0-VERV_TUNNEL/POORT/VIADUCT-0-00', '17,0-RVS DAMMAST COMBI GVB/OV-0-00', '302 0', '04,0-VRLP TOP76 11.02-9005 ZW-0-00', '10,0-RAGNI VLAGM 2GEB UL NICE-0-00', '03,5-BUISM V INDUSTRIA2310-0-00', '10,3-TELEPORT LOS NOK LOS UITH-0-00', '06,0-CV EU 1X750-15° T60 5011-1-00', '04,0-6009/ P-0-00', '08,0-NPK 1DEUR TOP 76-0-00', '12,0-2DEUR VOOR GSMZENDER-1-00', '10,0-M VPL+ BEV.PUNTEN-0-00', '10,0-CON T60 1D LPH8 SILL 7021-0-00', '08,0-RAGNI VLAGM 1NOK UITLNICE-0-00', '08,0-PLEIN MAX 3X UITH 9006-3-00', '08,0-CIL VARASTR GELAST 9006/P-0-00', '03,5-KNIPPERL.ARM MONT AAN OV-0-00', '02,9-BRUGPL VPL NM1883ZL REVIS-0-00', '04,0-VONDELPARK ZDEUR-0-00', '292 0', '007 0', '802 0', '06,0-ICON VTPL CIL 1XUITH 9005-1-00', '10,0-NKP 2DEUR TOP76 VPL-1-00', '04,5-MODEL PHILIPS 9005-0-00', '320 0', '08,0-CON T60 1D GAT 4,5M 7038-0-00', '00,0-OV-SI A/ MAST/INST DERDEN-0-00', '05,0-VOOR OPZETARM 60MM-0-00', '202 0', '10,0-ANWB ST BUISC TBV PANELEN-0-00', '16,0-PLEIN OUD 6XUITH VTP 7038-0-00', '05,0-BEGA 915 TOP76 ZWART-0-00', '06,0-GRNDPL-7038/P-0-00', '14,0-CIL CON TOP108-0-00', 'M....', '08,0-TUNNEL-POORT-VIADUCT E.D-0-00', '417 0', '10,0-VPL 550X550 ONGUITH 8/12M-2-00', '327 0', '14,0-BUISC 1 DEUR-0-00', '07,0-BUISC M VPL-0-00', '07,3-AANSL OP 3.5M/7.3M V ARM ZOB 7', '310 0', '12,0-BUISC KUNSTW LPH 6-7.5M-0-00', '03,5-VRLP TOP76-TYPE 11.01 ZW-0-00', '00,0-PUTKAST 300X150X353 RVS-0-00', '07,4-BUISC-0-00', '00,0-KAST INB RVS 350X110X160-0-00', '10,0-7038/P-0-00', '04,3-MAST BEGA VERL VPL GEB-1-02', '10,0-VOET GRT OM+VRLST..?/..?-0-00', '04,5-HAHN MZ455-1-00', '12,0-NPK 1DEUR TOP76-0-00', '045 0', '10,0-CON T60 VOETPLAAT 7021-0-00', '16,0-PLEIN 8XUITHOUDER 7021-8-00', '02,9-BRUGPL VPL OM1867ZL REVIS-0-00', '03,5-VTPL-TBV ARM.ZOB-7032-0-00', '04,9-TELEP TYPE 12-01-1-00', '06,0-CON GENORMALIS-0-00', '07,0-BUISC M GRST-0-00', 'M7000471', '05,0-BEGA 727S VPLT+BEGA899-0-00', '10,0-TOP60 1XGRVLG POEDER-0-00', '00,0-KAST KLEIN V/OV-0-00', '03,5-RAL9005-0-00', '04,0-ZDEUR 7038/P-0-00', '02,9-BRUGPL VPL NM1883ZL NIEUW-0-01', '065 0', '10,5-SPEC OP FUNDATIE(N MARKT)-0-00', '04,5-RVS IND VERLPLT LIIM3159-CDMT7', '10,0-RAGNI VLAGM 1GEBUITL NICE-0-00', '06,3-PLESMANLAAN 2D 7038+Z/W-1-00', 'M7201027', '418 0', '09,0-AFSPAN OV/GVB  DIEPERINK-1-00', 'M......', '502 0', '04,0-VRLP V SELUX SAT TOP89 VPL 900', '09,0-VERL VPL 77° 7005-0-00', '04,0-NPK 1DEUR TOP48-0-00', '00,0-KAST RVS RVN00-1DEUR/OV-0-00', '08,0-1Z GEBOGEN TYPE RAGNI-0-00', '400 0', '06,0-TUNNEL-POORT-VIADUCT E.D-0-00', '06,0-CON TOP76 CAL105 9005/P-0-00', '08,2-MILEWIDE 2VAST UITL1,5/1M-2-00', '10,0-CIL ONGEL UITL RIEKENPOL-2-00', 'M7100713', '092 0', 
    '10,5-OPZETSTUK NPK L2000 9006-1-00', '08,0-CIL EU1,5M VAST 1D 3V-1-00', '332 0', '2,9M GRACHTPAAL NM1883 ZLUIK NOIR S', '05,0-BEGA 727 GRONDSTUK-0-00', '312 0', '507 0', '06,0-ZUIL SEL STADSKAN-0-00', '376 0', '10,8-DREVEN/VOETPL UITH DUBBEL-2-00', '12,0-NPK +VOETPLT+FUNDATIESTUK-0-00', '04,0-CIL TOP76 CAL130 V BEGA-0-00', '04,8-VAST UITL 0,75M-1-00', '504 0', '04,0-CILCON VTPL 550X550 TOP76-0-00', '06,0-9005 +OGEN BOOMGELEIDING-0-00', '03,5-CON 1V D=133 T76 1D 9005-0-00', '07,0-NP 1DEUR TOP76 VPL-0-00', '04,1-PLESMANLN TBV 1Z SCH UITL 7038', '06,2-RVS NEMO M REFLPLAAT-0-00', '10,0-SELUX URBI 2 Z NOK 1 UITH-1-00', 'MAST-VERLOOP- 6M-VASTE GEBOGEN UITL', '10,3-TELEP2/3 VRI/OV 9017+7024-3-00', '10,0-CIL VARAS GEL 9006/P SOKK-0-00', '08,0-ANWB MAST-0-00', '03,5-CIL/CON-152/70MM-GRST1250 9006']
    
    # Vectorize the types using TF-IDF
    vectorizer = TfidfVectorizer().fit_transform(types)
    
    # Compute cosine similarity matrix
    similarity_matrix = cosine_similarity(vectorizer)
    similarity_matrix = np.clip(similarity_matrix, 0, 1)

    # Cluster with DBSCAN using a precomputed similarity matrix (converted to distances)
    dbscan = DBSCAN(metric="precomputed", eps=eps, min_samples=min_samples)
    clusters = dbscan.fit_predict(1 - similarity_matrix)  # Convert similarity to distance

    # Map each unique type to its cluster
    type_to_cluster = {type_: f"Cluster {cluster}" for type_, cluster in zip(types, clusters)}

    # Apply the mapping to the DataFrame to create a new column for the cluster labels
    df[f'text_cluster_{eps}_{min_samples}'] = df['Code'].map(type_to_cluster).fillna('No Cluster')

    # Save the DataFrame to a CSV file if a path is provided
    # if save_path:
    #     df.to_csv(save_path, index=False)
    #     print(f"DataFrame saved to {save_path}")

    print("Number of clusters: ", len(set(clusters) - {-1}))  # Exclude noise points
    print(clusters)
    return df


df = pd.read_csv('data/processed_sheets/combined_files_new_grouped.csv')
# assign_groups_by_text_clustering(df, 0.7, 3, save_path='data/processed_sheets/combined_files_new_grouped.csv')
# for i in range(0,13):    
code_values = list(set(df.loc[df['text_cluster_0.4_5'] == 'Cluster -1', 'Code'].tolist()))
print(code_values)
# open_and_display_images([sanitize_filename(code) + '.png' for code in code_values] , 'data/images/unique_codes')